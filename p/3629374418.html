<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="OpenSource,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0">






<meta name="description" content="需求场景最初，公共服务平台提供的是，基于某个开源 RPC 框架的 RPC 格式的接口。在上线一段时间后，我们发现这个开源 RPC 框架的 Bug 很多，多次因为框架本身的 Bug，导致整个公共服务平台的接口不可用，但又因为团队成员对框架源码不熟悉，并且框架的代码质量本身也不高，排查、修复起来花费了很长时间，影响面非常大。所以，我们评估下来，觉着这个框架的可靠性不够，维护成本、二次开发成本都太高，最">
<meta name="keywords" content="OpenSource">
<meta property="og:type" content="article">
<meta property="og:title" content="设计支持自定义规则的灰度发布组件">
<meta property="og:url" content="https://necusjz.github.io/p/3629374418.html">
<meta property="og:site_name" content="Ethan&#39;s Blog">
<meta property="og:description" content="需求场景最初，公共服务平台提供的是，基于某个开源 RPC 框架的 RPC 格式的接口。在上线一段时间后，我们发现这个开源 RPC 框架的 Bug 很多，多次因为框架本身的 Bug，导致整个公共服务平台的接口不可用，但又因为团队成员对框架源码不熟悉，并且框架的代码质量本身也不高，排查、修复起来花费了很长时间，影响面非常大。所以，我们评估下来，觉着这个框架的可靠性不够，维护成本、二次开发成本都太高，最">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2023-12-21T13:33:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="设计支持自定义规则的灰度发布组件">
<meta name="twitter:description" content="需求场景最初，公共服务平台提供的是，基于某个开源 RPC 框架的 RPC 格式的接口。在上线一段时间后，我们发现这个开源 RPC 框架的 Bug 很多，多次因为框架本身的 Bug，导致整个公共服务平台的接口不可用，但又因为团队成员对框架源码不熟悉，并且框架的代码质量本身也不高，排查、修复起来花费了很长时间，影响面非常大。所以，我们评估下来，觉着这个框架的可靠性不够，维护成本、二次开发成本都太高，最">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://necusjz.github.io/p/3629374418.html">





  <title> 设计支持自定义规则的灰度发布组件 | Ethan's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ethan's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://necusjz.github.io/p/3629374418.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="necusjz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ethan's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                设计支持自定义规则的灰度发布组件
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-31T11:50:35+08:00">
                2021-03-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景"></a>需求场景</h3><p>最初，公共服务平台提供的是，基于某个开源 RPC 框架的 RPC 格式的接口。在上线一段时间后，我们发现这个开源 RPC 框架的 Bug 很多，多次因为框架本身的 Bug，导致整个公共服务平台的接口不可用，但又因为团队成员对框架源码不熟悉，并且框架的代码质量本身也不高，排查、修复起来花费了很长时间，影响面非常大。所以，我们评估下来，觉着这个框架的可靠性不够，维护成本、二次开发成本都太高，最终决定替换掉它。<strong>对于引入新的框架，我们的要求是成熟、简单，并且与我们现有的技术栈（Spring）相吻合</strong>。这样，即便出了问题，我们也能利用之前积累的知识、经验来快速解决。所以，我们决定直接使用 Spring 框架来提供 RESTful 格式的远程接口。</p>
<p>把 RPC 接口替换成 RESTful 接口，除了需要修改公共服务平台的代码之外，调用方的接口调用代码也要做相应的修改。除此之外，对于公共服务平台的代码，尽管我们只是改动接口暴露方式，对业务代码基本上没有改动，但是，我们也并不能保证就完全不出问题。所以，为了保险起见，我们希望<strong>灰度替换掉老的 RPC 服务，而不是一刀切，在某个时间点上，让所有的调用方一下子都变成调用新的 RESTful 接口</strong>。因为替换的过程是灰度的，所以老的 RPC 服务不能下线，同时还要部署另外一套新的 RESTful 服务。我们先让业务不是很重要、流量不大的某个调用方，替换成调用新的 RESTful 接口。经过这个调用方一段时间的验证之后，如果新的 RESTful 接口没有问题，我们再逐步让其他调用方，替换成调用新的 RESTful 接口。</p>
<p>但是，如果万一中途出现问题，我们就需要将调用方的代码回滚，再重新部署，这就会导致调用方一段时间内服务不可用。而且，如果新的代码还包含调用方自身新的业务代码，简单通过 Git 回滚代码重新部署，会导致新的业务代码也被回滚。所以，为了避免这种情况的发生，我们就得手动将调用新的 RESTful 接口的代码删除，再改回为调用老的 RPC 接口；除此之外，为了不影响调用方本身业务的开发进度，调用方基于回滚之后的老代码，来做新功能开发，那替换成新的 RESTful 接口的那部分代码，要想再重新 merge 回去就比较难了，有可能会出现代码冲突，需要再重新开发。</p>
<a id="more"></a>

<p>在替换新的接口调用方式的时候，调用方并<strong>不直接将调用 RPC 接口的代码逻辑删除，而是新增调用 RESTful 接口的代码，通过一个功能开关，灵活切换走老的代码逻辑还是新的代码逻辑</strong>。代码示例如下所示。如果 callRestfulApi 为 true，就会走新的代码逻辑，调用 RESTful 接口，相反，就会走老的代码逻辑，继续调用 RPC 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> callRestfulApi = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!callRestfulApi) &#123;</span><br><span class="line">    <span class="comment">// 老的调用 RPC 接口的代码逻辑</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 新的调用 RESTful 接口的代码逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，更改 callRestfulApi 的值需要修改代码，而修改代码就要重新部署，这样的设计还是不够灵活。优化的方法，我想你应该已经想到了，<strong>把这个值放到配置文件或者配置中心</strong>就可以了。为了更加保险，不只是使用功能开关做新老接口调用方式的切换，我们还希望调用方在替换某个接口的时候，先让小部分接口请求，调用新的 RESTful 接口，剩下的大部分接口请求，还是调用老的 RPC 接口，验证没有问题之后，再<strong>逐步加大调用新接口的请求比例</strong>，最终，将所有的接口请求，都替换成调用新的接口。这就是所谓的“灰度”。</p>
<p>首先，我们要<strong>决定使用什么来做灰度，也就是灰度的对象</strong>。我们可以针对请求携带的时间戳信息、业务 ID 等信息，按照区间、比例或者具体的值来做灰度。我举个例子来解释一下，假设，我们要灰度的是根据用户 ID 查询用户信息接口。接口请求会携带用户 ID 信息，所以，我们就可以把用户 ID 作为灰度的对象。为了实现逐渐放量，我们先配置用户 ID 是 918、879、123（具体的值）的查询请求调用新接口，验证没有问题之后，我们再扩大范围，让用户 ID 在 1020~1120（区间值）之间的查询请求调用新接口。</p>
<p>如果验证之后还是没有问题，我们再继续扩大范围，让 10% 比例（比例值）的查询请求调用新接口（对应<strong>用户 ID 跟 10 取模求余小于 1 的请求</strong>）。以此类推，灰度范围逐步扩大到 20%、30%、50% 直到 100%。当灰度比例达到 100%，并且运行一段时间没有问题之后，调用方就可以把老的代码逻辑删除掉了。</p>
<p>实际上，类似的灰度需求场景还有很多。比如，在金融产品的清结算系统中，我们修改了清结算的算法。为了安全起见，我们可以灰度替换新的算法，把贷款 ID 作为灰度对象，先对某几个贷款应用新的算法，如果没有问题，再继续按照区间或者比例，扩大灰度范围。除此之外，为了保证代码万无一失，提前做好预案，添加或者修改一些复杂功能、核心功能，即便不做灰度，我们也建议通过功能开关，灵活控制这些功能的上下线。<strong>在不需要重新部署和重启系统的情况，做到快速回滚或新老代码逻辑的切换</strong>。</p>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>从实现的角度来讲，调用方只需要把灰度规则和功能开关，按照某种事先约定好的格式，存储到配置文件或者配置中心，在系统启动的时候，从中读取配置到内存中，之后，看灰度对象是否落在灰度范围内，以此来判定是否执行新的代码逻辑。但<strong>为了避免每个调用方都重复开发，我们把功能开关和灰度相关的代码，抽象封装为一个灰度组件</strong>，提供给各个调用方来复用。这里需要强调一点，我们这里的灰度，是代码级别的灰度，目的是保证项目质量，规避重大代码修改带来的不确定性风险。实际上，我们平时经常讲的灰度，一般都是产品层面或者系统层面的灰度。</p>
<p>所谓<strong>产品层面</strong>，有点类似 A/B Testing，让不同的用户看到不同的功能，对比两组用户的使用体验，收集数据，改进产品；所谓<strong>系统层面</strong>的灰度，往往不在代码层面上实现，一般是通过配置负载均衡或者 API-Gateway，来实现分配流量到不同版本的系统上。系统层面的灰度也是为了平滑上线功能，但比起我们讲到的代码层面的灰度，就没有那么细粒度了，开发和运维成本也相对要高些。</p>
<p>我们还是从使用的角度来分析。<strong>组件使用者需要设置一个 key 值，来唯一标识要灰度的功能，然后根据自己业务数据的特点，选择一个灰度对象</strong>（比如用户 ID），在配置文件或者配置中心中，配置这个 key 对应的灰度规则和功能开关。配置的格式类似下面这个样子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">features:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">call_newapi_getUserById</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span> <span class="string">//</span> <span class="string">enabled</span> <span class="string">为</span> <span class="literal">true</span> <span class="string">时，rule</span> <span class="string">才生效</span></span><br><span class="line">  <span class="attr">rule:</span> <span class="string">&#123;893,</span> <span class="number">342</span><span class="string">,</span> <span class="number">1020</span><span class="number">-1120</span><span class="string">,</span> <span class="string">%30&#125;</span> <span class="string">//</span> <span class="string">按照用户</span> <span class="string">ID</span> <span class="string">来做灰度</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">call_newapi_registerUser</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">rule:</span> <span class="string">&#123;1391198723,</span> <span class="string">%10&#125;</span> <span class="string">//</span> <span class="string">按照手机号来做灰度</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">newalgo_loan</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">rule:</span> <span class="string">&#123;0-1000&#125;</span> <span class="string">//</span> <span class="string">按照贷款的金额来做灰度</span></span><br></pre></td></tr></table></figure>

<p>灰度组件在业务系统启动的时候，会将这个灰度配置，按照事先定义的语法，解析并加载到内存对象中，业务系统直接使用组件提供的灰度判定接口，给业务系统使用，来判定某个灰度对象是否灰度执行新的代码逻辑。配置的加载解析、灰度判定逻辑这部分代码，都不需要业务系统来从零开发：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DarkFeature</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">enabled</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(String darkTarget)</span></span>; <span class="comment">// darkTarget 是灰度对象，比如前面提到的用户 ID、手机号码、金额等</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，总结一下的话，灰度组件跟限流框架很类似，它也主要包含两部分功能：</p>
<ol>
<li>灰度规则配置解析；</li>
<li>提供编程接口（DarkFeature）判定是否灰度；</li>
</ol>
<hr>
<h3 id="非功能性需求"><a href="#非功能性需求" class="headerlink" title="非功能性需求"></a>非功能性需求</h3><p>对于限流框架，我们主要从易用性、扩展性、灵活性、性能、容错性这几个方面，来分析它的非功能性需求。对于灰度组件，我们同样也从这几个方面来分析。</p>
<h4 id="易用性"><a href="#易用性" class="headerlink" title="易用性"></a>易用性</h4><p>因为接口的限流和幂等跟具体的业务是无关的，我们可以把限流和幂等相关的逻辑，跟业务代码解耦，统一放到公共的地方来处理（比如 Spring AOP 切面中）。但是，对于灰度来说，我们实现的灰度功能是代码级别的细粒度的灰度，而替代掉原来的 if-else 逻辑，是针对一个业务一个业务来做的，跟业务强相关，要<strong>做到跟业务代码完全解耦，是不现实的</strong>。所以，在侵入性这一点上，灰度组件只能做妥协，容忍一定程度的侵入。</p>
<p>除此之外，在灰度的过程中，我们要不停地修改灰度规则，在测试没有出现问题的情况下，逐渐放量。从运维的角度来说，如果每次修改灰度规则都要重启系统，显然是比较麻烦的。所以，我们希望<strong>支持灰度规则的热更新</strong>，也就是说，当我们在配置文件中，修改了灰度规则之后，系统在不重启的情况下会自动加载、更新灰度规则。</p>
<h4 id="扩展性、灵活性"><a href="#扩展性、灵活性" class="headerlink" title="扩展性、灵活性"></a>扩展性、灵活性</h4><p>跟限流框架一样，我们希望支持不同格式（JSON、YAML、XML 等）、不同存储方式（本地配置文件、Redis、Zookeeper 或者自研配置中心等）的灰度规则配置方式。</p>
<p>除此之外，对于灰度规则本身，在上一节课的示例中，我们定义了三种灰度规则语法格式：具体值（比如 893）、区间值（比如 1020-1120）、比例值（比如 %30）。不过，这只能处理比较简单的灰度规则。如果我们要支持更加复杂的灰度规则，比如只对 30 天内购买过某某商品并且退货次数少于 10 次的用户进行灰度，现在的灰度规则语法就无法支持了。所以，<strong>如何支持更加灵活的、复杂的灰度规则</strong>，也是我们设计实现的重点和难点。</p>
<h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><p>对于灰度组件来说，灰度的判断逻辑非常简单，而且不涉及访问外部存储，所以性能一般不会有太大问题。不过，我们仍然需要<strong>把灰度规则组织成快速查找的数据结构</strong>，能够支持快速判定某个灰度对象（darkTarget，比如用户 ID）是否落在灰度规则设定的区间内。</p>
<h4 id="容错性"><a href="#容错性" class="headerlink" title="容错性"></a>容错性</h4><p>两种对异常的处理思路：</p>
<ol>
<li>尽可能捕获所有异常，并且内部“消化”掉，不要往上层业务代码中抛出；</li>
<li>按照 fail-fast 原则，如果异常导致幂等逻辑无法正常执行，让业务代码也中止；</li>
</ol>
<p>对于灰度组件来说，上面的两种对异常的处理思路都是可以接受的。在灰度组件出现异常时，我们既可以选择中止业务，也可以选择让业务继续执行。如果让业务继续执行，本不应该被灰度到的业务对象，就有可能被执行，这是否能接受，还是要看具体的业务。不过，我个人倾向于采用类似幂等框架的处理思路，在出现异常时中止业务。</p>
<h3 id="框架设计思路"><a href="#框架设计思路" class="headerlink" title="框架设计思路"></a>框架设计思路</h3><p><strong>在性能和容错性方面，灰度组件并没有需要特别要处理的地方</strong>，重点需要关注的是易用性、扩展性、灵活性。详细来说，主要包括这样两点：支持更灵活、更复杂的灰度规则和支持灰度规则热更新。</p>
<h4 id="支持更灵活、更复杂的灰度规则"><a href="#支持更灵活、更复杂的灰度规则" class="headerlink" title="支持更灵活、更复杂的灰度规则"></a>支持更灵活、更复杂的灰度规则</h4><p>灰度规则的配置也是跟业务强相关的。业务方需要根据要灰度的业务特点，找到灰度对象（上节课中的 darkTarget，比如用户 ID），然后按照给出的灰度规则语法格式，配置相应的灰度规则。对于像刚刚提到的那种复杂的灰度规则（只对 30 天内购买过某某商品并且退货次数少于 10 次的用户进行灰度），<strong>通过定义语法规则来支持，是很难实现的</strong>。所以，针对复杂灰度规则，我们换个思路来实现。我暂时想到了两种解决方法：</p>
<ol>
<li>使用规则引擎，比如 Drools，可以在配置文件中调用 Java 代码；</li>
<li>支持编程实现灰度规则，这样做灵活性更高。不过，缺点是更新灰度规则需要更新代码，重新部署；</li>
</ol>
<p>对于大部分业务的灰度，我们使用前面定义的最基本的语法规则（具体值、区间值、比例值）就能满足了。对于极个别复杂的灰度规则，我们借鉴 Spring 的编程式配置，由业务方编程实现。之所以选择第二种实现方式，而不是使用 Drools 规则引擎，主要是出于<strong>不想为了不常用的功能，引入复杂的第三方框架，提高开发成本和灰度框架本身的学习成本</strong>。</p>
<h4 id="实现灰度规则热更新"><a href="#实现灰度规则热更新" class="headerlink" title="实现灰度规则热更新"></a>实现灰度规则热更新</h4><p>灰度规则的热更新实现起来并不难。我们创建一个定时器，每隔固定时间（比如 1 分钟），从配置文件中，读取灰度规则配置信息，并且解析加载到内存中，替换掉老的灰度规则。需要特别强调的是，更新灰度规则，涉及读取配置、解析、构建等一系列操作，会花费比较长的时间，我们不能因为更新规则，就暂停了灰度服务。所以，在设计和实现灰度规则更新的时候，我们要<strong>支持更新和查询并发执行</strong>。</p>
<hr>
<h3 id="灰度组件功能需求整理"><a href="#灰度组件功能需求整理" class="headerlink" title="灰度组件功能需求整理"></a>灰度组件功能需求整理</h3><p>我们还是按照老套路，从中剥离出 V1 版本要实现的内容：</p>
<ul>
<li><strong>灰度规则的格式和存储方式</strong>：我们希望支持不同格式（JSON、YAML、XML 等）、不同存储方式（本地配置文件、Redis、Zookeeper、或者自研配置中心等）的灰度规则配置方式；</li>
<li><strong>灰度规则的语法格式</strong>：我们支持三种灰度规则语法格式：具体值（比如 893）、区间值（比如 1020-1120）、比例值（比如 %30）。除此之外，对于更加复杂的灰度规则，比如只对 30 天内购买过某某商品并且退货次数少于 10 次的用户进行灰度，我们通过编程的方式来实现；</li>
<li><strong>灰度规则的内存组织方式</strong>：我们需要把灰度规则组织成支持快速查找的数据结构，能够快速判定某个灰度对象（darkTarget，比如用户 ID），是否落在灰度规则设定的范围内；</li>
<li><strong>灰度规则热更新</strong>：修改了灰度规则之后，我们希望不重新部署和重启系统，新的灰度规则就能生效，所以，我们需要支持灰度规则热更新；</li>
</ul>
<h3 id="实现灰度组件基本功能"><a href="#实现灰度组件基本功能" class="headerlink" title="实现灰度组件基本功能"></a>实现灰度组件基本功能</h3><p>在第一步中，我们先实现基于 YAML 格式的本地文件的灰度规则配置方式，以及灰度规则热更新，并且只支持三种基本的灰度规则语法格式。我们先把这个基本功能的开发需求，用代码实现出来。它的目录结构及其 Demo 示例如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码目录结构</span></span><br><span class="line">com.xzg.darklaunch</span><br><span class="line">  --DarkLaunch(框架的最顶层入口类)</span><br><span class="line">  --DarkFeature(每个 feature 的灰度规则)</span><br><span class="line">  --DarkRule(灰度规则)</span><br><span class="line">  --DarkRuleConfig(用来映射配置到内存中)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Demo 示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DarkLaunch darkLaunch = <span class="keyword">new</span> DarkLaunch();</span><br><span class="line">        DarkFeature darkFeature = darkLaunch.getDarkFeature(<span class="string">"call_newapi_getUserById"</span>);</span><br><span class="line">        System.out.println(darkFeature.enabled());</span><br><span class="line">        System.out.println(darkFeature.dark(<span class="number">893</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 灰度规则配置(dark-rule.yaml)放置在 classpath 路径下</span></span><br><span class="line">features:</span><br><span class="line">- key: call_newapi_getUserById</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  rule: &#123;<span class="number">893</span>, <span class="number">342</span>, <span class="number">1020</span>-<span class="number">1120</span>, %<span class="number">30</span>&#125;</span><br><span class="line">- key: call_newapi_registerUser</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  rule: &#123;<span class="number">1391198723</span>, %<span class="number">10</span>&#125;</span><br><span class="line">- key: newalgo_loan</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  rule: &#123;<span class="number">0</span>-<span class="number">1000</span>&#125;</span><br></pre></td></tr></table></figure>

<p>从 Demo 代码中，我们可以看出，对于业务系统来说，灰度组件的两个直接使用的类是 DarkLaunch 类和 DarkFeature 类。</p>
<p>我们先来看 DarkLaunch 类。这个类是<strong>灰度组件的最顶层入口类，它用来组装其他类对象，串联整个操作流程，提供外部调用的接口</strong>。DarkLaunch 类先读取灰度规则配置文件，映射为内存中的 Java 对象（DarkRuleConfig），然后再将这个中间结构，构建成一个支持快速查询的数据结构（DarkRule）。除此之外，它还负责定期更新灰度规则，也就是前面提到的灰度规则热更新。为了避免更新规则和查询规则的并发执行冲突，在更新灰度规则的时候，我们并非直接操作老的 DarkRule，而是先创建一个新的 DarkRule，然后等新的 DarkRule 都构建好之后，再“瞬间”赋值给老的 DarkRule。你可以结合着下面的代码一块看下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkLaunch</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(DarkLaunch<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_RULE_UPDATE_TIME_INTERVAL = <span class="number">60</span>; <span class="comment">// in seconds</span></span><br><span class="line">    <span class="keyword">private</span> DarkRule rule;</span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService executor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DarkLaunch</span><span class="params">(<span class="keyword">int</span> ruleUpdateTimeInterval)</span> </span>&#123;</span><br><span class="line">        loadRule();</span><br><span class="line">        <span class="keyword">this</span>.executor = Executors.newSingleThreadScheduledExecutor();</span><br><span class="line">        <span class="keyword">this</span>.executor.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                loadRule();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, ruleUpdateTimeInterval, ruleUpdateTimeInterval, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DarkLaunch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_RULE_UPDATE_TIME_INTERVAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将灰度规则配置文件 dark-rule.yaml 中的内容读取 DarkRuleConfig 中</span></span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        DarkRuleConfig ruleConfig = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            in = <span class="keyword">this</span>.getClass().getResourceAsStream(<span class="string">"/dark-rule.yaml"</span>);</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Yaml yaml = <span class="keyword">new</span> Yaml();</span><br><span class="line">                ruleConfig = yaml.loadAs(in, DarkRuleConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"close file error:&#123;&#125;"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ruleConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can not load dark rule."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新规则并非直接在 this.rule 上进行，</span></span><br><span class="line">        <span class="comment">// 而是通过创建一个新的 DarkRule，然后赋值给 this.rule，</span></span><br><span class="line">        <span class="comment">// 来避免更新规则和规则查询的并发冲突问题</span></span><br><span class="line">        DarkRule newRule = <span class="keyword">new</span> DarkRule(ruleConfig);</span><br><span class="line">        <span class="keyword">this</span>.rule = newRule;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DarkFeature <span class="title">getDarkFeature</span><span class="params">(String featureKey)</span> </span>&#123;</span><br><span class="line">        DarkFeature darkFeature = <span class="keyword">this</span>.rule.getDarkFeature(featureKey);</span><br><span class="line">        <span class="keyword">return</span> darkFeature;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再来看下 DarkRuleConfig 类。这个类功能非常简单，只是用来<strong>将灰度规则映射到内存中</strong>。具体的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkRuleConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;DarkFeatureConfig&gt; features;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;DarkFeatureConfig&gt; <span class="title">getFeatures</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.features;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFeatures</span><span class="params">(List&lt;DarkFeatureConfig&gt; features)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.features = features;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkFeatureConfig</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String key;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> enabled;</span><br><span class="line">        <span class="keyword">private</span> String rule;</span><br><span class="line">        <span class="comment">// 省略 getter、setter 方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中，我们可以看出来，DarkRuleConfig 类嵌套了一个内部类 DarkFeatureConfig。<strong>这两个类跟配置文件的两层嵌套结构完全对应</strong>。我把对应关系标注在了下面的示例中，你可以对照着代码看下：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!--对应 DarkRuleConfig--&gt;</span></span></span><br><span class="line"><span class="xml">features:                       </span></span><br><span class="line"><span class="xml">- key: call_newapi_getUserById  <span class="comment">&lt;!--对应 DarkFeatureConfig--&gt;</span></span></span><br><span class="line"><span class="xml">  enabled: true</span></span><br><span class="line"><span class="xml">  rule: </span><span class="template-variable">&#123;893, 342, 1020-1120, %30&#125;</span></span><br><span class="line"><span class="xml">- key: call_newapi_registerUser <span class="comment">&lt;!--对应 DarkFeatureConfig--&gt;</span></span></span><br><span class="line"><span class="xml">  enabled: true</span></span><br><span class="line"><span class="xml">  rule: </span><span class="template-variable">&#123;1391198723, %10&#125;</span></span><br><span class="line"><span class="xml">- key: newalgo_loan             <span class="comment">&lt;!--对应 DarkFeatureConfig--&gt;</span></span></span><br><span class="line"><span class="xml">  enabled: true</span></span><br><span class="line"><span class="xml">  rule: </span><span class="template-variable">&#123;0-1000&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们再来看下 DarkRule。DarkRule 包含所有要灰度的业务功能的灰度规则。它用来<strong>支持根据业务功能标识（feature key），快速查询灰度规则（DarkFeature）</strong>。代码也比较简单，具体如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkRule</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, DarkFeature&gt; darkFeatures = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DarkRule</span><span class="params">(DarkRuleConfig darkRuleConfig)</span> </span>&#123;</span><br><span class="line">        List&lt;DarkRuleConfig.DarkFeatureConfig&gt; darkFeatureConfigs = darkRuleConfig.getFeatures();</span><br><span class="line">        <span class="keyword">for</span> (DarkRuleConfig.DarkFeatureConfig darkFeatureConfig : darkFeatureConfigs) &#123;</span><br><span class="line">            darkFeatures.put(darkFeatureConfig.getKey(), <span class="keyword">new</span> DarkFeature(darkFeatureConfig));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DarkFeature <span class="title">getDarkFeature</span><span class="params">(String featureKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> darkFeatures.get(featureKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们最后来看下 DarkFeature 类。DarkFeature 类表示每个要灰度的业务功能的灰度规则。DarkFeature <strong>将配置文件中灰度规则，解析成一定的结构（比如 RangeSet），方便快速判定某个灰度对象是否落在灰度规则范围内</strong>。具体的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkFeature</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> percentage;</span><br><span class="line">    <span class="keyword">private</span> RangeSet&lt;Long&gt; rangeSet = TreeRangeSet.create();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DarkFeature</span><span class="params">(DarkRuleConfig.DarkFeatureConfig darkFeatureConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = darkFeatureConfig.getKey();</span><br><span class="line">        <span class="keyword">this</span>.enabled = darkFeatureConfig.getEnabled();</span><br><span class="line">        String darkRule = darkFeatureConfig.getRule().trim();</span><br><span class="line">        parseDarkRule(darkRule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseDarkRule</span><span class="params">(String darkRule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!darkRule.startsWith(<span class="string">"&#123;"</span>) || !darkRule.endsWith(<span class="string">"&#125;"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to parse dark rule: "</span> + darkRule);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] rules = darkRule.substring(<span class="number">1</span>, darkRule.length() - <span class="number">1</span>).split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">this</span>.rangeSet.clear();</span><br><span class="line">        <span class="keyword">this</span>.percentage = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (String rule : rules) &#123;</span><br><span class="line">            rule = rule.trim();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(rule)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rule.startsWith(<span class="string">"%"</span>)) &#123;</span><br><span class="line">                <span class="keyword">int</span> newPercentage = Integer.parseInt(rule.substring(<span class="number">1</span>));</span><br><span class="line">                <span class="keyword">if</span> (newPercentage &gt; <span class="keyword">this</span>.percentage) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.percentage = newPercentage;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rule.contains(<span class="string">"-"</span>)) &#123;</span><br><span class="line">                String[] parts = rule.split(<span class="string">"-"</span>);</span><br><span class="line">                <span class="keyword">if</span> (parts.length != <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to parse dark rule: "</span> + darkRule);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">long</span> start = Long.parseLong(parts[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">long</span> end = Long.parseLong(parts[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span> (start &gt; end) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to parse dark rule: "</span> + darkRule);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.rangeSet.add(Range.closed(start, end));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">long</span> val = Long.parseLong(rule);</span><br><span class="line">                <span class="keyword">this</span>.rangeSet.add(Range.closed(val, val));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(<span class="keyword">long</span> darkTarget)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> selected = <span class="keyword">this</span>.rangeSet.contains(darkTarget);</span><br><span class="line">        <span class="keyword">if</span> (selected) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> reminder = darkTarget % <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (reminder &gt;= <span class="number">0</span> &amp;&amp; reminder &lt; <span class="keyword">this</span>.percentage) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(String darkTarget)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> target = Long.parseLong(darkTarget);</span><br><span class="line">        <span class="keyword">return</span> dark(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加、优化灰度组件功能"><a href="#添加、优化灰度组件功能" class="headerlink" title="添加、优化灰度组件功能"></a>添加、优化灰度组件功能</h3><p>在第二步中，我们再实现基于编程的灰度规则配置方式，用来支持更加复杂、更加灵活的灰度规则。我们需要对于第一步实现的代码，进行一些改造。改造之后的代码目录结构如下所示。其中，DarkFeature、DarkRuleConfig 的基本代码不变，新增了 IDarkFeature 接口，DarkLaunch、DarkRule 的代码有所改动，用来支持编程实现灰度规则：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> 第一步的代码目录结构</span><br><span class="line">com.xzg.darklaunch</span><br><span class="line">  <span class="params">--DarkLaunch</span><span class="params">(框架的最顶层入口类)</span></span><br><span class="line">  <span class="params">--DarkFeature</span><span class="params">(每个 feature 的灰度规则)</span></span><br><span class="line">  <span class="params">--DarkRule</span><span class="params">(灰度规则)</span></span><br><span class="line">  <span class="params">--DarkRuleConfig</span><span class="params">(用来映射配置到内存中)</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 第二步的代码目录结构</span><br><span class="line">com.xzg.darklaunch</span><br><span class="line">  <span class="params">--DarkLaunch</span><span class="params">(框架的最顶层入口类，代码有改动)</span></span><br><span class="line">  <span class="params">--IDarkFeature</span><span class="params">(抽象接口)</span></span><br><span class="line">  <span class="params">--DarkFeature</span><span class="params">(实现 IDarkFeature 接口，基于配置文件的灰度规则，代码不变)</span></span><br><span class="line">  <span class="params">--DarkRule</span><span class="params">(灰度规则，代码有改动)</span></span><br><span class="line">  <span class="params">--DarkRuleConfig</span><span class="params">(用来映射配置到内存中，代码不变)</span></span><br></pre></td></tr></table></figure>

<p>我们先来看下 IDarkFeature 接口，它用来<strong>抽象从配置文件中得到的灰度规则，以及编程实现的灰度规则</strong>。具体代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDarkFeature</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">enabled</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(<span class="keyword">long</span> darkTarget)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(String darkTarget)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于这个抽象接口，业务系统可以自己编程实现复杂的灰度规则，然后添加到 DarkRule 中。为了避免配置文件中的灰度规则热更新时，覆盖掉编程实现的灰度规则，在 DarkRule 中，我们<strong>对从配置文件中加载的灰度规则和编程实现的灰度规则分开存储</strong>。按照这个设计思路，我们对 DarkRule 类进行重构。重构之后的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkRule</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从配置文件中加载的灰度规则</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IDarkFeature&gt; darkFeatures = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 编程实现的灰度规则</span></span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;String, IDarkFeature&gt; programmedDarkFeatures = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProgrammedDarkFeature</span><span class="params">(String featureKey, IDarkFeature darkFeature)</span> </span>&#123;</span><br><span class="line">        programmedDarkFeatures.put(featureKey, darkFeature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDarkFeatures</span><span class="params">(Map&lt;String, IDarkFeature&gt; newDarkFeatures)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.darkFeatures = newDarkFeatures;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IDarkFeature <span class="title">getDarkFeature</span><span class="params">(String featureKey)</span> </span>&#123;</span><br><span class="line">        IDarkFeature darkFeature = programmedDarkFeatures.get(featureKey);</span><br><span class="line">        <span class="keyword">if</span> (darkFeature != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> darkFeature;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> darkFeatures.get(featureKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 DarkRule 代码有所修改，对应地，DarkLaunch 的代码也需要做少许改动，主要有一处修改和一处新增代码，具体如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkLaunch</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(DarkLaunch<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_RULE_UPDATE_TIME_INTERVAL = <span class="number">60</span>; <span class="comment">// in seconds</span></span><br><span class="line">    <span class="keyword">private</span> DarkRule rule = <span class="keyword">new</span> DarkRule();</span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService executor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DarkLaunch</span><span class="params">(<span class="keyword">int</span> ruleUpdateTimeInterval)</span> </span>&#123;</span><br><span class="line">        loadRule();</span><br><span class="line">        <span class="keyword">this</span>.executor = Executors.newSingleThreadScheduledExecutor();</span><br><span class="line">        <span class="keyword">this</span>.executor.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                loadRule();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, ruleUpdateTimeInterval, ruleUpdateTimeInterval, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DarkLaunch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_RULE_UPDATE_TIME_INTERVAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        DarkRuleConfig ruleConfig = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            in = <span class="keyword">this</span>.getClass().getResourceAsStream(<span class="string">"/dark-rule.yaml"</span>);</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Yaml yaml = <span class="keyword">new</span> Yaml();</span><br><span class="line">                ruleConfig = yaml.loadAs(in, DarkRuleConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"close file error:&#123;&#125;"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ruleConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Can not load dark rule."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 修改：单独更新从配置文件中得到的灰度规则，不覆盖编程实现的灰度规则</span></span><br><span class="line">        Map&lt;String, IDarkFeature&gt; darkFeatures = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        List&lt;DarkRuleConfig.DarkFeatureConfig&gt; darkFeatureConfigs = ruleConfig.getFeatures();</span><br><span class="line">        <span class="keyword">for</span> (DarkRuleConfig.DarkFeatureConfig darkFeatureConfig : darkFeatureConfigs) &#123;</span><br><span class="line">            darkFeatures.put(darkFeatureConfig.getKey(), <span class="keyword">new</span> DarkFeature(darkFeatureConfig));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.rule.setDarkFeatures(darkFeatures);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增：添加编程实现的灰度规则的接口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProgrammedDarkFeature</span><span class="params">(String featureKey, IDarkFeature darkFeature)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rule.addProgrammedDarkFeature(featureKey, darkFeature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IDarkFeature <span class="title">getDarkFeature</span><span class="params">(String featureKey)</span> </span>&#123;</span><br><span class="line">        IDarkFeature darkFeature = <span class="keyword">this</span>.rule.getDarkFeature(featureKey);</span><br><span class="line">        <span class="keyword">return</span> darkFeature;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再通过一个 Demo 来看下，目前实现的灰度组件该如何使用。结合着 Demo，再去理解上面的代码，会更容易些。Demo 代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 灰度规则配置(dark-rule.yaml)，放到 classpath 路径下</span></span><br><span class="line">features:</span><br><span class="line">- key: call_newapi_getUserById</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  rule: &#123;<span class="number">893</span>, <span class="number">342</span>, <span class="number">1020</span>-<span class="number">1120</span>, %<span class="number">30</span>&#125;</span><br><span class="line">- key: call_newapi_registerUser</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  rule: &#123;<span class="number">1391198723</span>, %<span class="number">10</span>&#125;</span><br><span class="line">- key: newalgo_loan</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  rule: &#123;<span class="number">0</span>-<span class="number">100</span>&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 编程实现的灰度规则</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserPromotionDarkRule</span> <span class="keyword">implements</span> <span class="title">IDarkFeature</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(<span class="keyword">long</span> darkTarget)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 灰度规则自己想怎么写就怎么写</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dark</span><span class="params">(String darkTarget)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 灰度规则自己想怎么写就怎么写</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Demo</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DarkLaunch darkLaunch = <span class="keyword">new</span> DarkLaunch(); <span class="comment">// 默认加载 classpath 下 dark-rule.yaml 文件中的灰度规则</span></span><br><span class="line">        darkLaunch.addProgrammedDarkFeature(<span class="string">"user_promotion"</span>, <span class="keyword">new</span> UserPromotionDarkRule()); <span class="comment">// 添加编程实现的灰度规则</span></span><br><span class="line">        IDarkFeature darkFeature = darkLaunch.getDarkFeature(<span class="string">"user_promotion"</span>);</span><br><span class="line">        System.out.println(darkFeature.enabled());</span><br><span class="line">        System.out.println(darkFeature.dark(<span class="number">893</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OpenSource/" rel="tag"># OpenSource</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/p/104703185.html" rel="next" title="设计通用的接口幂等框架">
                <i class="fa fa-chevron-left"></i> 设计通用的接口幂等框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/p/1666378453.html" rel="prev" title="从容器到容器云：谈谈 Kubernetes 的本质">
                从容器到容器云：谈谈 Kubernetes 的本质 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="necusjz">
          <p class="site-author-name" itemprop="name">necusjz</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">266</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#需求场景"><span class="nav-number">1.</span> <span class="nav-text">需求场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#需求分析"><span class="nav-number">2.</span> <span class="nav-text">需求分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非功能性需求"><span class="nav-number">3.</span> <span class="nav-text">非功能性需求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#易用性"><span class="nav-number">3.1.</span> <span class="nav-text">易用性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#扩展性、灵活性"><span class="nav-number">3.2.</span> <span class="nav-text">扩展性、灵活性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#性能"><span class="nav-number">3.3.</span> <span class="nav-text">性能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#容错性"><span class="nav-number">3.4.</span> <span class="nav-text">容错性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#框架设计思路"><span class="nav-number">4.</span> <span class="nav-text">框架设计思路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#支持更灵活、更复杂的灰度规则"><span class="nav-number">4.1.</span> <span class="nav-text">支持更灵活、更复杂的灰度规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现灰度规则热更新"><span class="nav-number">4.2.</span> <span class="nav-text">实现灰度规则热更新</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#灰度组件功能需求整理"><span class="nav-number">5.</span> <span class="nav-text">灰度组件功能需求整理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现灰度组件基本功能"><span class="nav-number">6.</span> <span class="nav-text">实现灰度组件基本功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加、优化灰度组件功能"><span class="nav-number">7.</span> <span class="nav-text">添加、优化灰度组件功能</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">necusjz</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

  

  

  


  

</body>
</html>
