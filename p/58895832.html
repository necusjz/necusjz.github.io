<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="SystemDesign,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0">






<meta name="description" content="A key-value store, also referred to as a key-value database, is a non-relational database. Each unique identifier is stored as a key with its associated value. This data pairing is known as a “key-val">
<meta name="keywords" content="SystemDesign">
<meta property="og:type" content="article">
<meta property="og:title" content="Design a Key-value Store">
<meta property="og:url" content="https://necusjz.github.io/p/58895832.html">
<meta property="og:site_name" content="Ethan&#39;s Blog">
<meta property="og:description" content="A key-value store, also referred to as a key-value database, is a non-relational database. Each unique identifier is stored as a key with its associated value. This data pairing is known as a “key-val">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/00.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/01.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/02.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/03.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/04.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/05.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/06.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/07.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/08.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/09.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/10.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/11.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/12.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/13.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/14.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/15.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/16.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/17.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/18.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/19.svg">
<meta property="og:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/20.svg">
<meta property="og:updated_time" content="2023-12-21T13:33:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Design a Key-value Store">
<meta name="twitter:description" content="A key-value store, also referred to as a key-value database, is a non-relational database. Each unique identifier is stored as a key with its associated value. This data pairing is known as a “key-val">
<meta name="twitter:image" content="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/00.svg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://necusjz.github.io/p/58895832.html">





  <title> Design a Key-value Store | Ethan's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ethan's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://necusjz.github.io/p/58895832.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="necusjz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ethan's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Design a Key-value Store
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2023-10-25T15:35:55+08:00">
                2023-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>A key-value store, also referred to as a key-value database, is a non-relational database. Each unique identifier is stored as a key with its associated value. This data pairing is known as a “key-value” pair.</p>
<p>In a key-value pair, the key must be unique, and the value associated with the key can be accessed through the key. Keys can be plain text or hashed values. For performance reasons, a short key works better. What do keys look like? Here are a few examples:</p>
<ul>
<li>Plain text key: “last_logged_in_at”</li>
<li>Hashed key: 253DDEC4</li>
</ul>
<p>The value in a key-value pair can be strings, lists, objects, etc. The value is usually treated as an opaque object in key-value stores, such as Amazon dynamo [1], Memcached [2], Redis [3], etc.</p>
<p>Here is a data snippet in a key-value store:</p>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">145</td>
<td align="left">john</td>
</tr>
<tr>
<td align="left">147</td>
<td align="left">bob</td>
</tr>
<tr>
<td align="left">160</td>
<td align="left">julia</td>
</tr>
</tbody></table>
<p>In this chapter, you are asked to design a key-value store that supports the following operations:</p>
<ul>
<li>put(key, value)  // insert “value” associated with “key”</li>
<li>get(key)  // get “value” associated with “key”</li>
</ul>
<a id="more"></a>
<h2 id="Understand-the-problem-and-establish-design-scope"><a href="#Understand-the-problem-and-establish-design-scope" class="headerlink" title="Understand the problem and establish design scope"></a>Understand the problem and establish design scope</h2><p>There is no perfect design. Each design achieves a specific balance regarding the tradeoffs of the read, write, and memory usage. Another tradeoff has to be made was between consistency and availability. In this chapter, we design a key-value store that comprises of the following characteristics:</p>
<ul>
<li>The size of a key-value pair is small: less than 10 KB.</li>
<li>Ability to store big data.</li>
<li>High availability: The system responds quickly, even during failures.</li>
<li>High scalability: The system can be scaled to support large data set.</li>
<li>Automatic scaling: The addition/deletion of servers should be automatic based on traffic.</li>
<li>Tunable consistency.</li>
<li>Low latency.</li>
</ul>
<h2 id="Single-server-key-value-store"><a href="#Single-server-key-value-store" class="headerlink" title="Single server key-value store"></a>Single server key-value store</h2><p>Developing a key-value store that resides in a single server is easy. An intuitive approach is to store key-value pairs in a hash table, which keeps everything in memory. Even though memory access is fast, fitting everything in memory may be impossible due to the space constraint. Two optimizations can be done to fit more data in a single server:</p>
<ul>
<li>Data compression.</li>
<li>Store only frequently used data in memory and the rest on disk.</li>
</ul>
<p>Even with these optimizations, a single server can reach its capacity very quickly. A distributed key-value store is required to support big data.</p>
<h2 id="Distributed-key-value-store"><a href="#Distributed-key-value-store" class="headerlink" title="Distributed key-value store"></a>Distributed key-value store</h2><p>A distributed key-value store is also called a distributed hash table, which distributes key-value pairs across many servers. When designing a distributed system, it is important to understand CAP theorem.</p>
<h3 id="CAP-theorem"><a href="#CAP-theorem" class="headerlink" title="CAP theorem"></a>CAP theorem</h3><p>CAP theorem states it is impossible for a distributed system to simultaneously provide more than two of these three guarantees: consistency, availability, and partition tolerance. Let us establish a few definitions:</p>
<ul>
<li><strong>C</strong>onsistency: All clients see the same data at the same time no matter which node they connect to.</li>
<li><strong>A</strong>vailability: Any client which requests data gets a response even if some of the nodes are down.</li>
<li><strong>P</strong>artition tolerance: The system continues to operate despite network partitions. A partition indicates a communication break between two nodes.</li>
</ul>
<p>CAP theorem states that one of the three properties must be sacrificed to support 2 of the 3 properties as shown in Figure 1.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/00.svg" alt></p>
<p>Nowadays, key-value stores are classified based on the two CAP characteristics they support:</p>
<ul>
<li>CP systems: A CP key-value store supports consistency and partition tolerance while sacrificing availability.</li>
<li>AP systems: An AP key-value store supports availability and partition tolerance while sacrificing consistency.</li>
<li>CA systems: A CA key-value store supports consistency and availability while sacrificing partition tolerance. Since network failure is unavoidable, a distributed system must tolerate network partition. Thus, a CA system cannot exist in real-world applications.</li>
</ul>
<p>What you read above is mostly the definition part. To make it easier to understand, let us take a look at some concrete examples. In distributed systems, data is usually replicated multiple times. Assume data are replicated on three replica nodes, n1, n2 and n3 as shown in Figure 2.</p>
<p>In the ideal world, network partition never occurs. Data written to n1 is automatically replicated to n2 and n3. Both consistency and availability are achieved.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/01.svg" alt></p>
<p>In a distributed system, partitions cannot be avoided, and when a partition occurs, we must choose between consistency and availability. In Figure 3, n3 goes down and cannot communicate with n1 and n2. If clients write data to n1 or n2, data cannot be propagated to n3. If data is written to n3 but not propagated to n1 and n2 yet, n1 and n2 would have stale data.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/02.svg" alt></p>
<p>If we choose consistency over availability (CP system), we must block all write operations to n1 and n2 to avoid data inconsistency among these three servers, which makes the system unavailable. Bank systems usually have extremely high consistent requirements. For example, it is crucial for a bank system to display the most up-to-date balance info. If inconsistency occurs due to a network partition, the bank system returns an error before the inconsistency is resolved.</p>
<p>However, if we choose availability over consistency (AP system), the system keeps accepting reads, even though it might return stale data. For writes, n1 and n2 will keep accepting writes, and data will be synced to n3 when the network partition is resolved.</p>
<p>Choosing the right CAP guarantees that fit your use case is an important step in building a distributed key-value store. You can discuss this with your interviewer and design the system accordingly.</p>
<h2 id="System-components"><a href="#System-components" class="headerlink" title="System components"></a>System components</h2><p>In this section, we will discuss the following core components and techniques used to build a key-value store:</p>
<ul>
<li>Data partition</li>
<li>Data replication</li>
<li>Consistency</li>
<li>Inconsistency resolution</li>
<li>Handling failures</li>
<li>System architecture diagram</li>
<li>Write path</li>
<li>Read path</li>
</ul>
<p>The content below is largely based on three popular key-value store systems: Dynamo [4], Cassandra [5], and BigTable [6].</p>
<h3 id="Data-partition"><a href="#Data-partition" class="headerlink" title="Data partition"></a>Data partition</h3><p>For large applications, it is infeasible to fit the complete data set in a single server. The simplest way to accomplish this is to split the data into smaller partitions and store them in multiple servers. There are two challenges while partitioning the data:</p>
<ul>
<li>Distribute data across multiple servers evenly.</li>
<li>Minimize data movement when nodes are added or removed.</li>
</ul>
<p>Consistent hashing discussed in the previous chapter is a great technique to solve these problems. Let us revisit how consistent hashing works at a high-level.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/03.svg" alt></p>
<ul>
<li>First, servers are placed on a hash ring. In Figure 4, eight servers, represented by s0, s1, …, s7, are placed on the hash ring.</li>
<li>Next, a key is hashed onto the same ring, and it is stored on the first server encountered while moving in the clockwise direction. For instance, key0 is stored in s1 using this logic.</li>
</ul>
<p>Using consistent hashing to partition data has the following advantages:</p>
<ul>
<li>Automatic scaling: Servers could be added and removed automatically depending on the load.</li>
<li>Heterogeneity: The number of virtual nodes for a server is proportional to the server capacity. For example, servers with higher capacity are assigned with more virtual nodes.</li>
</ul>
<h3 id="Data-replication"><a href="#Data-replication" class="headerlink" title="Data replication"></a>Data replication</h3><p>To achieve high availability and reliability, data must be replicated asynchronously over N servers, where N is a configurable parameter. These N servers are chosen using the following logic: After a key is mapped to a position on the hash ring, walk clockwise from that position and choose the first N servers on the ring to store data copies. In Figure 5 (N=3), key0 is replicated at s1, s2, and s3.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/04.svg" alt></p>
<p>With virtual nodes, the first N nodes on the ring may be owned by fewer than N physical servers. To avoid this issue, we only choose unique servers while performing the clockwise walk logic.</p>
<p>Nodes in the same data center often fail at the same time due to power outages, network issues, natural disasters, etc. For better reliability, replicas are placed in distinct data centers, and data centers are connected through high-speed networks.</p>
<h3 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h3><p>Since data is replicated at multiple nodes, it must be synchronized across replicas. Quorum consensus can guarantee consistency for both read and write operations. Let us establish a few definitions first.</p>
<ul>
<li>N: The number of replicas</li>
<li>W: A write quorum of size W. For a write operation to be considered as successful, write operation must be acknowledged from W replicas.</li>
<li>R: A read quorum of size R. For a read operation to be considered as successful, read operation must wait for responses from at least R replicas.</li>
</ul>
<p>Consider the following example shown in Figure 6 with N=3.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/05.svg" alt></p>
<p>W=1 does not mean data is written on one server. For instance, with the configuration in Figure 6, data is replicated at s0, s1, and s2. W=1 means that the coordinator must receive at least one acknowledgment before the write operation is considered as successful. For instance, if we get an acknowledgment from s1, we no longer need to wait for acknowledgements from s0 and s2. A coordinator acts as a proxy between the client and the nodes.</p>
<p>The configuration of W, R and N is a typical tradeoff between latency and consistency. If W=1 or R=1, an operation is returned quickly because a coordinator only needs to wait for a response from any of the replicas. If W or R &gt; 1, the system offers better consistency; however, the query will be slower because the coordinator must wait for the response from the slowest replica.</p>
<p>If W + R &gt; N, strong consistency is guaranteed because there must be at least one overlapping node that has the latest data to ensure consistency.</p>
<p>How to configure N, W, and R to fit our use cases? Here are some of the possible setups:</p>
<ul>
<li>If R=1 and W=N, the system is optimized for a fast read.</li>
<li>If W=1 and R=N, the system is optimized for fast write.</li>
<li>If W + R &gt; N, strong consistency is guaranteed (Usually N=3, W=R=2).</li>
<li>If W + R &lt;= N, strong consistency is not guaranteed.</li>
</ul>
<p>Depending on the requirement, we can tune the values of W, R, N to achieve the desired level of consistency.</p>
<h4 id="Consistency-models"><a href="#Consistency-models" class="headerlink" title="Consistency models"></a>Consistency models</h4><p>Consistency model is other important factor to consider when designing a key-value store. A consistency model defines the degree of data consistency, and a wide spectrum of possible consistency models exist:</p>
<ul>
<li>Strong consistency: Any read operation returns a value corresponding to the result of the most updated write data item. A client never sees out-of-date data.</li>
<li>Weak consistency: Subsequent read operations may not see the most updated value.</li>
<li>Eventual consistency: This is a specific form of weak consistency. Given enough time, all updates are propagated, and all replicas are consistent.</li>
</ul>
<p>Strong consistency is usually achieved by forcing a replica not to accept new reads/writes until every replica has agreed on current write. This approach is not ideal for highly available systems because it could block new operations. Dynamo and Cassandra adopt eventual consistency, which is our recommended consistency model for our key-value store. From concurrent writes, eventual consistency allows inconsistent values to enter the system and force the client to read the values to reconcile. The next section explains how reconciliation works with versioning.</p>
<h3 id="Inconsistency-resolution"><a href="#Inconsistency-resolution" class="headerlink" title="Inconsistency resolution"></a>Inconsistency resolution</h3><p>Replication gives high availability but causes inconsistencies among replicas. Versioning and vector locks are used to solve inconsistency problems. Versioning means treating each data modification as a new immutable version of data. Before we talk about versioning, let us use an example to explain how inconsistency happens: As shown in Figure 7, both replica nodes n1 and n2 have the same value. Let us call this value the original value, server 1 and server 2 get the same value for get(“name”) operation.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/06.svg" alt></p>
<p>Next, server 1 changes the name to “johnSanFrancisco”, and server 2 changes the name to “johnNewYork” as shown in Figure 8. These two changes are performed simultaneously. Now, we have conflicting values, called versions v1 and v2.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/07.svg" alt></p>
<p>In this example, the original value could be ignored because the modifications were based on it. However, there is no clear way to resolve the conflict of the last two versions. To resolve this issue, we need a versioning system that can detect conflicts and reconcile conflicts. A vector clock is a common technique to solve this problem. Let us examine how vector clocks work.</p>
<p>A vector clock is a [server, version] pair associated with a data item. It can be used to check if one version precedes, succeeds, or in conflict with others.</p>
<p>Assume a vector clock is represented by D([S1, v1], [S2, v2], …, [Sn, vn]), where D is a data item, v1 is a version counter, and S1 is a server number, etc. If data item D is written to server Si, the system must perform one of the following tasks.</p>
<ul>
<li>Increment vi if [Si, vi] exists.</li>
<li>Otherwise, create a new entry [Si, 1].</li>
</ul>
<p>The above abstract logic is explained with a concrete example as shown in Figure 9:<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/08.svg" alt></p>
<ol>
<li>A client writes a data item D1 to the system, and the write is handled by server Sx, which now has the vector clock D1[(Sx, 1)].</li>
<li>Another client reads the latest D1, updates it to D2, and writes it back. D2 descends from D1 so it overwrites D1. Assume the write is handled by the same server Sx, which now has vector clock D2([Sx, 2]).</li>
<li>Another client reads the latest D2, updates it to D3, and writes it back. Assume the write is handled by server Sy, which now has vector clock D3([Sx, 2], [Sy, 1])).</li>
<li>Another client reads the latest D2, updates it to D4, and writes it back. Assume the write is handled by server Sz, which now has D4([Sx, 2], [Sz, 1])).</li>
<li>When another client reads D3 and D4, it discovers a conflict, which is caused by data item D2 being modified by both Sy and Sz. The conflict is resolved by the client and updated data is sent to the server. Assume the write is handled by Sx, which now has D5([Sx, 3], [Sy, 1], [Sz, 1]). We will explain how to detect conflict shortly.</li>
</ol>
<p>Using vector clocks, it is easy to tell that a version X is an ancestor (i.e, no conflict) of version Y if the version counters for each participant in the vector clock of Y is greater than or equal to the ones in version X. For example, the vector clock D([S0, 1], [S1, 1])] is an ancestor of D([S0, 1], [S1, 2]). Therefore, no conflict is recorded.</p>
<p>Similarly, you can tell that a version X is a sibling (i.e., a conflict exists) of Y if there is any participant in Y’s vector clock who has a counter that is less than its corresponding counter in X. For example, the following two vector clocks indicate there is a conflict: D([S0, 1], [S1, 2]) and D([S0, 2], [S1, 1]).</p>
<p>Even though vector clocks can resolve conflicts, there are two notable downsides. First, vector clocks add complexity to the client because it needs to implement conflict resolution logic.</p>
<p>Second, the [server, version] pairs in the vector clock could grow rapidly. To fix this problem, we set a threshold for the length, and if it exceeds the limit, the oldest pairs are removed. This can lead to inefficiencies in reconciliation because the descendant relationship cannot be determined accurately. However, based on Dynamo paper [4], Amazon has not yet encountered this problem in production; therefore, it is probably an acceptable solution for most companies.</p>
<h3 id="Handling-failures"><a href="#Handling-failures" class="headerlink" title="Handling failures"></a>Handling failures</h3><p>As with any large system at scale, failures are not only inevitable but common. Handling failure scenarios is very important. In this section, we first introduce techniques to detect failures. Then, we go over common failure resolution strategies.</p>
<h4 id="Failure-detection"><a href="#Failure-detection" class="headerlink" title="Failure detection"></a>Failure detection</h4><p>In a distributed system, it is insufficient to believe that a server is down because another server says so. Usually, it requires at least two independent sources of information to mark a server down.</p>
<p>As shown in Figure 10, all-to-all multicasting is a straightforward solution. However, this is inefficient when many servers are in the system.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/09.svg" alt></p>
<p>A better solution is to use decentralized failure detection methods like gossip protocol. Gossip protocol works as follows:</p>
<ul>
<li>Each node maintains a node membership list, which contains member IDs and heartbeat counters.</li>
<li>Each node periodically increments its heartbeat counter.</li>
<li>Each node periodically sends heartbeats to a set of random nodes, which in turn propagate to another set of nodes.</li>
<li>Once nodes receive heartbeats, membership list is updated to the latest info.</li>
<li>If the heartbeat has not increased for more than predefined periods, the member is considered as offline.</li>
</ul>
<p>As shown in Figure 11:<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/10.svg" alt></p>
<ul>
<li>Node s0 maintains a node membership list shown on the left side.</li>
<li>Node s0 notices that node s2’s (member ID = 2) heartbeat counter has not increased for a long time.</li>
<li>Node s0 sends heartbeats that include s2’s info to a set of random nodes. Once other nodes confirm that s2’s heartbeat counter has not been updated for a long time, node s2 is marked down, and this information is propagated to other nodes.</li>
</ul>
<h4 id="Handling-temporary-failures"><a href="#Handling-temporary-failures" class="headerlink" title="Handling temporary failures"></a>Handling temporary failures</h4><p>After failures have been detected through the gossip protocol, the system needs to deploy certain mechanisms to ensure availability. In the strict quorum approach, read and write operations could be blocked as illustrated in the quorum consensus section.</p>
<p>A technique called “sloppy quorum” [4] is used to improve availability. Instead of enforcing the quorum requirement, the system chooses the first W healthy servers for writes and first R healthy servers for reads on the hash ring. Offline servers are ignored.</p>
<p>If a server is unavailable due to network or server failures, another server will process requests temporarily. When the down server is up, changes will be pushed back to achieve data consistency. This process is called hinted handoff. Since s2 is unavailable in Figure 12, reads and writes will be handled by s3 temporarily. When s2 comes back online, s3 will hand the data back to s2.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/11.svg" alt></p>
<h4 id="Handling-permanent-failures"><a href="#Handling-permanent-failures" class="headerlink" title="Handling permanent failures"></a>Handling permanent failures</h4><p>Hinted handoff is used to handle temporary failures. What if a replica is permanently unavailable? To handle such a situation, we implement an anti-entropy protocol to keep replicas in sync. Anti-entropy involves comparing each piece of data on replicas and updating each replica to the newest version. A Merkle tree is used for inconsistency detection and minimizing the amount of data transferred.</p>
<p>Quoted from Wikipedia [7]: “A hash tree or Merkle tree is a tree in which every non-leaf node is labeled with the hash of the labels or values (in case of leaves) of its child nodes. Hash trees allow efficient and secure verification of the contents of large data structures”.</p>
<p>Assuming key space is from 1 to 12, the following steps show how to build a Merkle tree. Highlighted boxes indicate inconsistency:</p>
<ol>
<li>Divide key space into buckets (4 in our example) as shown in Figure 13. A bucket is used as the root level node to maintain a limited depth of the tree.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/12.svg" alt></li>
<li>Once the buckets are created, hash each key in a bucket using a uniform hashing method.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/13.svg" alt></li>
<li>Create a single hash node per bucket.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/14.svg" alt></li>
<li>Build the tree upwards till root by calculating hashes of children.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/15.svg" alt></li>
</ol>
<p>To compare two Merkle trees, start by comparing the root hashes. If root hashes match, both servers have the same data. If root hashes disagree, then the left child hashes are compared followed by right child hashes. You can traverse the tree to find which buckets are not synchronized and synchronize those buckets only.</p>
<p>Using Merkle trees, the amount of data needed to be synchronized is proportional to the differences between the two replicas, and not the amount of data they contain. In real-world systems, the bucket size is quite big. For instance, a possible configuration is one million buckets per one billion keys, so each bucket only contains 1000 keys.</p>
<h4 id="Handling-data-center-outage"><a href="#Handling-data-center-outage" class="headerlink" title="Handling data center outage"></a>Handling data center outage</h4><p>Data center outage could happen due to power outage, network outage, natural disaster, etc. To build a system capable of handling data center outage, it is important to replicate data across multiple data centers. Even if a data center is completely offline, users can still access data through the other data centers.</p>
<h3 id="System-architecture-diagram"><a href="#System-architecture-diagram" class="headerlink" title="System architecture diagram"></a>System architecture diagram</h3><p>Now that we have discussed different technical considerations in designing a key-value store, we can shift our focus on the architecture diagram, shown in Figure 17.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/16.svg" alt></p>
<p>Main features of the architecture are listed as follows:</p>
<ul>
<li>Clients communicate with the key-value store through simple APIs: get(key) and put(key, value).</li>
<li>A coordinator is a node that acts as a proxy between the client and the key-value store.</li>
<li>Nodes are distributed on a ring using consistent hashing.</li>
<li>The system is completely decentralized, so adding and moving nodes can be automatic.</li>
<li>Data is replicated at multiple nodes.</li>
<li>There is no single point of failure as every node has the same set of responsibilities.</li>
</ul>
<p>As the design is decentralized, each node performs many tasks as presented in Figure 18.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/17.svg" alt></p>
<h3 id="Write-path"><a href="#Write-path" class="headerlink" title="Write path"></a>Write path</h3><p>Figure 19 explains what happens after a write request is directed to a specific node. Please note the proposed designs for write/read paths are primary based on the architecture of Cassandra [8]:<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/18.svg" alt></p>
<ol>
<li>The write request is persisted on a commit log file.</li>
<li>Data is saved in the memory cache.</li>
<li>When the memory cache is full or reaches a predefined threshold, data is flushed to SSTable [9] on disk.</li>
</ol>
<h3 id="Read-path"><a href="#Read-path" class="headerlink" title="Read path"></a>Read path</h3><p>After a read request is directed to a specific node, it first checks if data is in the memory cache. If so, the data is returned to the client as shown in Figure 20.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/19.svg" alt></p>
<p>If the data is not in memory, it will be retrieved from the disk instead. We need an efficient way to find out which SSTable contains the key. Bloom filter [10] is commonly used to solve this problem.</p>
<p>The read path is shown in Figure 21 when data is not in memory.<br><img src="https://raw.githubusercontent.com/necusjz/p/master/SystemDesign/bytebytego/07/20.svg" alt></p>
<ol>
<li>The system first checks if data is in memory. If not, go to step 2.</li>
<li>If data is not in memory, the system checks the bloom filter.</li>
<li>The bloom filter is used to figure out which SSTables might contain the key.</li>
<li>SSTables return the result of the data set.</li>
<li>The result of the data set is returned to the client.</li>
</ol>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This chapter covers many concepts and techniques. To refresh your memory, the following table summarizes features and corresponding techniques used for a distributed key-value store:</p>
<table>
<thead>
<tr>
<th align="left">Goal/Problems</th>
<th align="left">Technique</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Ability to store big data</td>
<td align="left">Use consistent hashing to spread load across servers</td>
</tr>
<tr>
<td align="left">High availability reads</td>
<td align="left">Data replication, Multi-datacenter setup</td>
</tr>
<tr>
<td align="left">Highly available writes</td>
<td align="left">Versioning and conflict resolution with vector clocks</td>
</tr>
<tr>
<td align="left">Dataset partition</td>
<td align="left">Consistent Hashing</td>
</tr>
<tr>
<td align="left">Incremental scalability</td>
<td align="left">Consistent Hashing</td>
</tr>
<tr>
<td align="left">Heterogeneity</td>
<td align="left">Consistent Hashing</td>
</tr>
<tr>
<td align="left">Tunable consistency</td>
<td align="left">Quorum consensus</td>
</tr>
<tr>
<td align="left">Handling temporary failures</td>
<td align="left">Sloppy quorum and hinted handoff</td>
</tr>
<tr>
<td align="left">Handling permanent failures</td>
<td align="left">Merkle tree</td>
</tr>
<tr>
<td align="left">Handling data center outage</td>
<td align="left">Cross-datacenter replication</td>
</tr>
</tbody></table>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[1] Amazon DynamoDB: <a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noopener">https://aws.amazon.com/dynamodb/</a><br>[2] memcached: <a href="https://memcached.org/" target="_blank" rel="noopener">https://memcached.org/</a><br>[3] Redis: <a href="https://redis.io/" target="_blank" rel="noopener">https://redis.io/</a><br>[4] Dynamo: Amazon’s Highly Available Key-value Store:<br><a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf" target="_blank" rel="noopener">https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf</a><br>[5] Cassandra: <a href="https://cassandra.apache.org/" target="_blank" rel="noopener">https://cassandra.apache.org/</a><br>[6] Bigtable: A Distributed Storage System for Structured Data:<br><a href="https://static.googleusercontent.com/media/research.google.com/en//archive/bigtable-osdi06.pdf" target="_blank" rel="noopener">https://static.googleusercontent.com/media/research.google.com/en//archive/bigtable-osdi06.pdf</a><br>[7] Merkle tree: <a href="https://en.wikipedia.org/wiki/Merkle_tree" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Merkle_tree</a><br>[8] Cassandra architecture: <a href="https://cassandra.apache.org/doc/latest/architecture/" target="_blank" rel="noopener">https://cassandra.apache.org/doc/latest/architecture/</a><br>[9] SStable: <a href="https://www.igvita.com/2012/02/06/sstable-and-log-structured-storage-leveldb/" target="_blank" rel="noopener">https://www.igvita.com/2012/02/06/sstable-and-log-structured-storage-leveldb/</a><br>[10] Bloom filter <a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Bloom_filter</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SystemDesign/" rel="tag"># SystemDesign</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/p/3609435369.html" rel="next" title="Design Consistent Hashing">
                <i class="fa fa-chevron-left"></i> Design Consistent Hashing
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/p/2993337315.html" rel="prev" title="Design a Unique ID Generator in Distributed Systems">
                Design a Unique ID Generator in Distributed Systems <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="necusjz">
          <p class="site-author-name" itemprop="name">necusjz</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">279</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Understand-the-problem-and-establish-design-scope"><span class="nav-number">1.</span> <span class="nav-text">Understand the problem and establish design scope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Single-server-key-value-store"><span class="nav-number">2.</span> <span class="nav-text">Single server key-value store</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Distributed-key-value-store"><span class="nav-number">3.</span> <span class="nav-text">Distributed key-value store</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CAP-theorem"><span class="nav-number">3.1.</span> <span class="nav-text">CAP theorem</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#System-components"><span class="nav-number">4.</span> <span class="nav-text">System components</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-partition"><span class="nav-number">4.1.</span> <span class="nav-text">Data partition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-replication"><span class="nav-number">4.2.</span> <span class="nav-text">Data replication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consistency"><span class="nav-number">4.3.</span> <span class="nav-text">Consistency</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Consistency-models"><span class="nav-number">4.3.1.</span> <span class="nav-text">Consistency models</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Inconsistency-resolution"><span class="nav-number">4.4.</span> <span class="nav-text">Inconsistency resolution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Handling-failures"><span class="nav-number">4.5.</span> <span class="nav-text">Handling failures</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Failure-detection"><span class="nav-number">4.5.1.</span> <span class="nav-text">Failure detection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Handling-temporary-failures"><span class="nav-number">4.5.2.</span> <span class="nav-text">Handling temporary failures</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Handling-permanent-failures"><span class="nav-number">4.5.3.</span> <span class="nav-text">Handling permanent failures</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Handling-data-center-outage"><span class="nav-number">4.5.4.</span> <span class="nav-text">Handling data center outage</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#System-architecture-diagram"><span class="nav-number">4.6.</span> <span class="nav-text">System architecture diagram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-path"><span class="nav-number">4.7.</span> <span class="nav-text">Write path</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-path"><span class="nav-number">4.8.</span> <span class="nav-text">Read path</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">5.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">6.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">necusjz</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

  

  

  


  

</body>
</html>
